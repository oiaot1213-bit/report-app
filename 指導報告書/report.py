import streamlit as st
import os
from dotenv import load_dotenv
from google import genai

# --- 1.設定と準備 ---
st.set_page_config(page_title="授業レポート生成AI", layout="centered")
load_dotenv()
api_key = os.getenv("GEMINI_API_KEY")

# --- 2.データの定義(JavaでいうMapやList) ---
# 学年に応じて科目を出し分けるための辞書
subjects_map={
    "中1":["英語", "数学", "国語", "理科", "社会", "その他"],
    "中2":["英語", "数学", "国語", "理科", "社会", "その他"],
    "中3":["英語", "数学", "国語", "理科", "社会", "その他"],
    "高1":["英語", "数学I", "数学A", "物理", "化学", "生物", "現代文", "古文", "漢文", "地理", "歴史", "公共（公民）", "情報", "その他"],
    "高2":["英語", "数学IA", "数学II", "数学B", "数学IIIC", "物理", "化学", "生物", "現代文", "古文", "漢文", "地理", "歴史", "公共（公民）", "情報", "入試対策", "その他"],
    "高3":["英語", "数学IA", "数学IIB", "数学III", "数学C", "物理", "化学", "生物", "現代文", "古文", "漢文", "地理", "歴史", "公共（公民）", "情報", "入試対策", "その他"],
}

# --- 3.サイドバーやタイトルの表示 ---
st.title("授業レポート生成AI")
st.caption("必要事項を入力したらAIが授業レポートを書いてくれます")

# --- 4. 入力フォーム ---
col1, col2 = st.columns(2)
with col1:
    grade = st.selectbox("学年", list(subjects_map.keys()))
with col2:
    target_subjects = subjects_map[grade]
    subject = st.selectbox("科目", target_subjects)

unit = st.text_input("授業単元", placeholder="例：一次関数、比較級、力学")

content_points = st.text_area("授業内容・初めて習ったこと・生徒の様子(箇条書き）", height=120, 
    placeholder="・テストの復習\n・計算ミスはあるが、やり方は理解している\n・日本語訳ができるようになった\n")

next_plan = st.text_input("次回の予定", placeholder="例：学校の予習の続き、難易度の高い問題演習")

commnts = st.text_area("+αのコメント", height=100, 
    placeholder="・テスト頑張ってください\n・来週保護者面談があります\n")

# --- 5. プロンプト（AIへの命令）の作成 ---
if st.button("報告書を作成する", type="primary"):
    if not api_key:
        st.error("APIキーが設定されていません。")
    elif not content_points:
        st.warning("「授業内容」を入力してください。")
    else:
        client = genai.Client(api_key=api_key)

        # ここに「あなたの過去の文章（Few-Shot）」を埋め込みます
        # これがあることで、AIはあなたの文体を真似します
        prompt = f"""
        あなたは学習塾の講師です。以下の情報を元に、保護者向けの「指導報告書」を作成してください。
        
        【重要：文体のルール】
        - 箇条書きは使わず、自然な日本語の文章（段落）で構成すること。
        - 3段落構成にすること
        - 文字数は全体で絶対300~400文字にすること
        - 個別指導なので保護者は一人を想定すること。
        - 出だしは「今回は」から始めること
        - 1段落目は挨拶ではなく今回の授業で扱った内容の大まかな説明をすること(20~70字)
        - 2段落目は授業の詳細や生徒の様子を書くこと(100~200字)
        - 3段落目は次回予告をして最後に必ず「引き続きよろしくお願いいたします。」で締めること。(50~150字)
        - 文末は「〜ていただきました」「〜と思われます」など、丁寧で謙虚な表現を使うこと。
        - 良い点は具体的に褒め、改善点は前向きな表現（〜していきたいです）にすること。
        

        【参考にする例文（文体）】
        例1：
        今回は期末テストに向けて、「1次関数の利用」の単元の学習を進めてきました。
        まず初めに、前回の予習として「1次関数の利用」の分野の復習をしました。一次関数を現実に応用して用いる際に、グラフの傾きや切片はどのような意味を持つのかについて確認しました。
        次回からは新しく「平行と合同」の単元に入ります。ここでは今までの単元に比べて覚えることが増えるため、予習をしていただければと思います。引き続きよろしくお願い致します。
        
        例2：
        今回は、新しく「平行と合同」という単元を始めました。
        まずは最初の範囲として「平行線と角」の重要なキーワードである「対頂角」、「同位角」、「錯角」について取り扱いました。これらがどういう意味で用いられるのかを例を複数用いて確認しました。また、これらと平行な直線の関係を用いて図の角度を求める問題を考えてもらいました。今まで行った単元に比べて計算量は少ないですが知識が一つでも抜けているとたちまち分からなくなりやすいので、言葉とその意味と例をこれから毎回確認できればと思います。
        また、新しい単元に入りましたが、おそらく期末テストは今まで行なった「一次関数」の単元が重きをおくはずです。そのため次回以降は、テスト範囲までは新しいところを進めつつ、一次関数の演習にも取り組んでいく予定です。引き続きよろしくお願いいたします。
        
        例3：
        今回は、前回に引き続き「平行と合同」の単元をテスト範囲まで進めた後に、「一次関数」全体の復習を行いました。
        「平行と合同」の単元からは、今回新しく三角形の内角と外角の性質について取り扱いました。重要な性質の1つとして、三角形の3つの内角の和は180度というものがあります。この性質から他の様々な性質を導き出すことができます。以前行なった平行線と角の範囲と組みあわせた問題を何問か解いてもらいました。
        「一次関数」の単元からは、塾のワークを用いて単元全体の基本問題を一通り解いていただきました。どの問題もしっかり考え方が身についておりました。このレベルの問題がテストで出たら、できる限りケアレスミスせずに確実に点を取っていただきたいです。
        次回(今週の日曜日)はテスト前最後の授業として比較的難易度の高い問題を中心に取り扱っていきたいと思います。引き続きよろしくお願いいたします。


        例4：
        今回は期末テスト前最後の授業として、テスト範囲全体で気になった部分を復習してもらいました。
        前回の授業で特に文字式の分野が不安であったため、ワークを用いて問題を解いてもらいました。計算式の形から何をすればよいかが分かるようになっており、ほとんどのパターンに対応できていました。ただ、やはりケアレスミスの頻度が決して少なくないので落ち着いて見直しもして頂きたいです。
        今回も授業の様子を見る限り8割近く取れる実力があると思います。そのため、取るべき問題を落とさないために見直しをしっかりして頂きたいです。頑張ってください。

        【今回の授業データ】
        - 学年・科目: {grade} {subject}
        - 単元: {unit}
        - 内容と様子: {content_points}
        - 次回の予定: {next_plan}
        - コメント: {commnts}
        
        【出力してほしい報告書】
        """

        with st.spinner("AIが報告書を考えているよ..."):
            try:
                response = client.models.generate_content(
                    model="gemini-2.5-flash",
                    contents=prompt
                )
                
                st.subheader("完成案")
                st.text_area("コピー用", value=response.text, height=400)
                st.success("できました！微調整して使ってください。")
                
            except Exception as e:
                st.error(f"エラーが発生しました: {e}")